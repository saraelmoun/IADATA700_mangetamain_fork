

<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.components.popularity_analysis_page &mdash; Documentation MangetamainTESTWR 1.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=7a28dfa3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=e6b791cb"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MangetamainTESTWR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">IADATA700_mangetamain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">src</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ClassDiagram.html">Diagramme de classes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MangetamainTESTWR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Code du module</a></li>
      <li class="breadcrumb-item active">src.components.popularity_analysis_page</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de src.components.popularity_analysis_page</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="sd">&quot;&quot;&quot;Streamlit page: Analyse de popularité des recettes.</span>

<span class="sd">Analyse des relations entre popularité, notes et caractéristiques structurelles.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">core.data_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.interactions_analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span> <span class="n">PreprocessingConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>


<div class="viewcode-block" id="PopularityAnalysisConfig">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.popularity_analysis_page.PopularityAnalysisConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PopularityAnalysisConfig</span><span class="p">:</span>
    <span class="n">interactions_path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">recipes_path</span><span class="p">:</span> <span class="n">Path</span></div>



<div class="viewcode-block" id="PopularityAnalysisPage">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.popularity_analysis_page.PopularityAnalysisPage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PopularityAnalysisPage</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactions_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">recipes_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PopularityAnalysisConfig</span><span class="p">(</span>
            <span class="n">interactions_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">interactions_path</span><span class="p">),</span>
            <span class="n">recipes_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">recipes_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

    <span class="c1"># ---------------- Sidebar ---------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sidebar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 📊 Visualisation&quot;</span><span class="p">)</span>
        <span class="n">plot_type</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
            <span class="s2">&quot;Type de graphique&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;Scatter&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scatter: points individuels, Histogram: nombre d&#39;observations par bins&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">:</span>
            <span class="n">n_bins</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="s2">&quot;Nombre de bins&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">bin_agg</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>  <span class="c1"># Fixé à count seulement</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">bin_agg</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="s2">&quot;Transparence&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Preprocessing section</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### ⚙️ Preprocessing&quot;</span><span class="p">)</span>
        <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
            <span class="s2">&quot;Seuil outliers&quot;</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Multiplicateur IQR pour filtrer les outliers techniques (minutes, n_steps, n_ingredients). Plus élevé = moins de filtrage.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;plot_type&quot;</span><span class="p">:</span> <span class="n">plot_type</span><span class="p">,</span>
            <span class="s2">&quot;n_bins&quot;</span><span class="p">:</span> <span class="n">n_bins</span><span class="p">,</span>
            <span class="s2">&quot;bin_agg&quot;</span><span class="p">:</span> <span class="n">bin_agg</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
            <span class="s2">&quot;outlier_threshold&quot;</span><span class="p">:</span> <span class="n">outlier_threshold</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_cache_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render cache management controls in sidebar.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 🗄️ Cache Management&quot;</span><span class="p">)</span>

        <span class="c1"># Get cache info</span>
        <span class="n">cache_info</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">get_cache_info</span><span class="p">()</span>

        <span class="c1"># Cache status</span>
        <span class="n">cache_enabled</span> <span class="o">=</span> <span class="n">cache_info</span><span class="p">[</span><span class="s2">&quot;cache_enabled&quot;</span><span class="p">]</span>
        <span class="n">cache_exists</span> <span class="o">=</span> <span class="n">cache_info</span><span class="p">[</span><span class="s2">&quot;cache_exists&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cache_enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache_exists</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Cache disponible&quot;</span><span class="p">)</span>
                <span class="c1"># Show cache details</span>
                <span class="k">if</span> <span class="s2">&quot;cache_age_minutes&quot;</span> <span class="ow">in</span> <span class="n">cache_info</span><span class="p">:</span>
                    <span class="n">age_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;cache_age_minutes&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> min&quot;</span>
                    <span class="n">size_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;cache_size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Age: </span><span class="si">{</span><span class="n">age_str</span><span class="si">}</span><span class="s2">, Taille: </span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cache sera créé après preprocessing&quot;</span><span class="p">)</span>

            <span class="c1"># Cache management buttons</span>
            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;🗑️ Clear Cache&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Supprimer tous les fichiers de cache&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">():</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Cache effacé!&quot;</span><span class="p">)</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Erreur lors de l&#39;effacement&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;ℹ️ Info Cache&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Afficher les détails du cache&quot;</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">cache_info</span><span class="p">)</span>

            <span class="c1"># Show total cache files</span>
            <span class="k">if</span> <span class="n">cache_info</span><span class="p">[</span><span class="s2">&quot;cache_files_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 </span><span class="si">{</span><span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;cache_files_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> fichier(s) de cache&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cache désactivé&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_popularity_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span> <span class="n">pop_rating</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render popularity segmentation analysis.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;📋 Segmentation par popularité&quot;</span><span class="p">)</span>

        <span class="c1"># Create popularity segments</span>
        <span class="n">segmented_data</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">create_popularity_segments</span><span class="p">(</span><span class="n">pop_rating</span><span class="p">)</span>

        <span class="c1"># Get threshold information from analyzer</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_popularity_segments_info</span><span class="p">[</span><span class="s2">&quot;thresholds&quot;</span><span class="p">]</span>

        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="c1"># Distribution of segments with precise intervals</span>
            <span class="n">segment_counts</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;**Distribution des segments avec intervalles précis:**&quot;</span><span class="p">)</span>

            <span class="c1"># Display segments with their exact interaction count ranges</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_counts</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">segment_counts</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>
                    <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">segmented_data</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

                    <span class="c1"># Define interval text based on segment</span>
                    <span class="k">if</span> <span class="n">segment</span> <span class="o">==</span> <span class="s2">&quot;Low&quot;</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;1 à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> fois&quot;</span>
                    <span class="k">elif</span> <span class="n">segment</span> <span class="o">==</span> <span class="s2">&quot;Medium&quot;</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;medium_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> fois&quot;</span>
                    <span class="k">elif</span> <span class="n">segment</span> <span class="o">==</span> <span class="s2">&quot;High&quot;</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;medium_max&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> fois&quot;</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Viral</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plus de </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> fois&quot;</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">segment</span><span class="si">}</span><span class="s2">** (</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> recettes (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="c1"># Average rating by segment</span>
            <span class="n">segment_ratings</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">)[</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">])</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;**Note moyenne par segment:**&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_ratings</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">mean_rating</span> <span class="o">=</span> <span class="n">segment_ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span>
                    <span class="n">std_rating</span> <span class="o">=</span> <span class="n">segment_ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">segment_ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">segment</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mean_rating</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_rating</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> recettes)&quot;</span><span class="p">)</span>

        <span class="c1"># Visualization of segments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_popularity_segments</span><span class="p">(</span><span class="n">segmented_data</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_popularity_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segmented_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create visualization for popularity segments.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Plot 1: Boxplot of ratings by segment</span>
        <span class="n">segment_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]</span>
        <span class="n">segments_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segment_order</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">segments_present</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">segmented_data</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">segments_present</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution des notes par segment de popularité&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Segment de popularité&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Note moyenne&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="c1"># Plot 2: Distribution des recettes par nombre d&#39;interactions</span>
        <span class="c1"># Créons un histogramme pour visualiser la vraie distribution</span>
        <span class="n">interactions_counts</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1"># Limitons à 30 interactions max pour la lisibilité</span>
        <span class="n">max_interactions</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">interactions_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">interactions_limited</span> <span class="o">=</span> <span class="n">interactions_counts</span><span class="p">[</span><span class="n">interactions_counts</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">max_interactions</span><span class="p">]</span>

        <span class="c1"># Créons le graphique en barres</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">interactions_limited</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">interactions_limited</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Ajoutons les lignes de seuils de segmentation</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_popularity_segments_info</span><span class="p">[</span><span class="s2">&quot;thresholds&quot;</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;low_max&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;P25 = </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;low_max&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;medium_max&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;P75 = </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;medium_max&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;high_max&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;P95 = </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s2">&quot;high_max&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Nombre d&#39;interactions&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Nombre de recettes&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution: Combien de recettes pour chaque niveau d&#39;interactions&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Calculons les pourcentages réels dynamiquement</span>
        <span class="n">segment_counts</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">total_recipes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segmented_data</span><span class="p">)</span>
        <span class="n">segment_percentages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_counts</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">segment_percentages</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_counts</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_recipes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segment_percentages</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Ajoutons des annotations pour les zones avec pourcentages dynamiques</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Low</span><span class="se">\n</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">2.5</span><span class="p">,</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Medium</span><span class="se">\n</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s2">&quot;Medium&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mi">8</span><span class="p">,</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;High</span><span class="se">\n</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">max_interactions</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mi">20</span><span class="p">,</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;Viral</span><span class="se">\n</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s2">&quot;Viral&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightcoral&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Calculons les statistiques pour l&#39;explication (éviter de recalculer)</span>
        <span class="n">segment_counts</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">total_recipes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segmented_data</span><span class="p">)</span>
        <span class="n">low_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_recipes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">viral_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Viral&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_recipes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">low_count</span> <span class="o">=</span> <span class="n">segment_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_popularity_segments_info</span><span class="p">[</span><span class="s2">&quot;thresholds&quot;</span><span class="p">]</span>

        <span class="c1"># Explication de la distribution observée avec pourcentages dynamiques</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        **🔍 Lecture de la distribution (graphique de droite) :**</span>

<span class="s2">        Ce graphique révèle la **réalité de l&#39;engagement** sur les plateformes de contenu :</span>
<span class="s2">        - **Très haute colonne à 1 interaction** : </span><span class="si">{</span><span class="n">low_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes (~</span><span class="si">{</span><span class="n">low_count</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1000</span><span class="si">}</span><span class="s2">k) n&#39;ont qu&#39;une seule interaction</span>
<span class="s2">        - **Décroissance rapide** : Plus le nombre d&#39;interactions augmente, moins il y a de recettes</span>
<span class="s2">        - **Rareté du viral** : Très peu de recettes dépassent </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> interactions (seuil viral P95)</span>

<span class="s2">        Cette distribution de type **&quot;longue traîne&quot;** est typique des plateformes de contenu et</span>
<span class="s2">        **renforce la valeur** de notre analyse : identifier les facteurs qui distinguent les </span><span class="si">{</span><span class="n">viral_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">        de recettes virales des </span><span class="si">{</span><span class="n">low_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% à faible engagement devient d&#39;autant plus précieux !</span>

<span class="s2">        **📐 Pourquoi pas exactement 25%/50%/75%/95% ?**</span>

<span class="s2">        Les percentiles P25/P75/P95 sont corrects, mais avec des **données discrètes entières**</span>
<span class="s2">        (1, 2, 3... interactions), les segments ne peuvent pas être exactement équilibrés :</span>

<span class="s2">        - **P25 = </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">** : mais </span><span class="si">{</span><span class="n">low_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes ont exactement </span><span class="si">{</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> interaction</span>
<span class="s2">        - **Impossible d&#39;avoir exactement 25%** sans utiliser des seuils fractionnaires (1.5, 2.3...)</span>
<span class="s2">        - **C&#39;est mathématiquement normal** : les percentiles indiquent les valeurs, pas forcément des répartitions égales</span>

<span class="s2">        Cette asymétrie **renforce l&#39;analyse** : elle reflète la vraie nature de l&#39;engagement numérique !</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_1</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bin_agg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render step 1: Quality-popularity relationship analysis.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;📈  ÉTAPE 1 : Relation qualité-popularité&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Question :** Les recettes bien notées génèrent-elles plus d&#39;interactions ?</span>

<span class="sd">        Cette première analyse croise la note moyenne des recettes avec leur nombre d&#39;interactions</span>
<span class="sd">        pour évaluer la corrélation entre qualité perçue et engagement utilisateur.</span>

<span class="sd">        **Métrique :** Corrélation entre note moyenne et nombre d&#39;interactions par recette.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pop_rating</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">popularity_vs_rating</span><span class="p">()</span>
            <span class="n">fig1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plot</span><span class="p">(</span>
                <span class="n">pop_rating</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
                <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
                <span class="n">bin_agg</span><span class="o">=</span><span class="n">bin_agg</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>

            <span class="c1"># Analyse des résultats</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            **� Observations :** La distribution révèle plusieurs clusters de recettes avec des niveaux</span>
<span class="sd">            d&#39;engagement distincts. Les recettes à haute popularité ne présentent pas systématiquement</span>
<span class="sd">            les meilleures notes, suggérant l&#39;existence de facteurs additionnels.</span>

<span class="sd">            **� Implication :** Cette distribution non-linéaire indique que la popularité s&#39;organise</span>
<span class="sd">            en segments distincts plutôt qu&#39;en progression continue. Cependant une grande majorité des recettes possède une bonne note.</span>
<span class="sd">            Les utilisateurs sont peut-être bienveillant entre eux ou les recettes sont peut-être toutes délicieuses.</span>
<span class="sd">            Nous allons donc plutôt nous focaliser dans la suite sur l&#39;étude du nombre de fois où une recette a été faite soit sa</span>
<span class="sd">            popularité pour qualifier son succés tout en gardant un oeil sur sa note.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">pop_rating</span>  <span class="c1"># Return for use in step 2</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Impossible de tracer Note vs Popularité: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span> <span class="n">pop_rating</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render step 2: Popularity segmentation analysis.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;📈  ÉTAPE 2 : Segmentation par engagement&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Objectif :** Identifier et caractériser les différents segments de popularité.</span>

<span class="sd">        La distribution observée suggère l&#39;existence de groupes distincts de recettes. Nous appliquons</span>
<span class="sd">        une segmentation basée sur les percentiles pour révéler la structure naturelle de la popularité.</span>

<span class="sd">        **Méthode :** Segmentation par percentiles (25e, 75e, 95e) du nombre d&#39;interactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Segmentation par popularité avec contexte narratif</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_popularity_segmentation</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">pop_rating</span><span class="p">)</span>

        <span class="c1"># Obtenir les seuils de segmentation pour l&#39;explication</span>
        <span class="n">segmented_data</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">create_popularity_segments</span><span class="p">(</span><span class="n">pop_rating</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_popularity_segments_info</span><span class="p">[</span><span class="s2">&quot;thresholds&quot;</span><span class="p">]</span>

        <span class="c1"># Calculer les pourcentages réels de chaque segment</span>
        <span class="n">segment_counts</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">total_recipes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segmented_data</span><span class="p">)</span>
        <span class="n">segment_percentages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_counts</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">segment_percentages</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_counts</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_recipes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segment_percentages</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        **📋 Caractérisation des segments identifiés :**</span>

<span class="s2">        L&#39;analyse révèle quatre segments distincts basés sur le niveau d&#39;engagement :</span>

<span class="s2">        - **Engagement Faible** : 1 à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> interactions</span>
<span class="s2">          (</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes - souvent de qualité mais visibilité limitée)</span>

<span class="s2">        - **Engagement Modéré** : </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_max&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;medium_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> interactions</span>
<span class="s2">          (</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s1">&#39;Medium&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes - performance stable et audience fidèle)</span>

<span class="s2">        - **Engagement Élevé** : </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;medium_max&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> à </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> interactions</span>
<span class="s2">          (</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes - forte popularité établie)</span>

<span class="s2">        - **Engagement Viral** : Plus de </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_max&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> interactions</span>
<span class="s2">          (</span><span class="si">{</span><span class="n">segment_percentages</span><span class="p">[</span><span class="s1">&#39;Viral&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% des recettes - phénomènes d&#39;adoption exceptionnelle)</span>

<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_3</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span>
        <span class="n">agg</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bin_agg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">pop_rating</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render step 3: Technical factors influence analysis.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;📈  ÉTAPE 3 : Facteurs d&#39;influence&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Objectif :** Identifier les caractéristiques intrinsèques des recettes qui corrèlent</span>
<span class="sd">        avec une popularité élevée.</span>

<span class="sd">        Au-delà de la qualité, trois dimensions techniques peuvent influencer l&#39;adoption d&#39;une recette :</span>
<span class="sd">        le temps de préparation, la complexité (nombre d&#39;étapes) et les ingrédients requis.</span>

<span class="sd">        **Méthode :** Analyse de corrélation entre caractéristiques techniques et niveau d&#39;engagement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Caractéristiques (feature) vs Popularité avec la note comme taille</span>
        <span class="n">feature_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;n_steps&quot;</span><span class="p">,</span> <span class="s2">&quot;n_ingredients&quot;</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_order</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">agg</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
                <span class="c1"># Contexte analytique pour chaque caractéristique</span>
                <span class="k">if</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    #### ⏱️ Impact du temps de préparation</span>

<span class="sd">                    **Hypothèse :** Les recettes rapides sont plus populaires dans une société pressée.</span>
<span class="sd">                    **Variable :** Temps de préparation en minutes vs nombre d&#39;interactions.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;n_steps&quot;</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    #### 🧩 Influence de la complexité procédurale</span>

<span class="sd">                    **Hypothèse :** La complexité (nombre d&#39;étapes) peut freiner l&#39;adoption mais améliorer la satisfaction.</span>
<span class="sd">                    **Variable :** Nombre d&#39;étapes vs nombre d&#39;interactions.</span>
<span class="sd">                    **Observation :** Équilibre entre accessibilité et sophistication.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;n_ingredients&quot;</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    #### 🥘 Effet de la diversité des ingrédients</span>

<span class="sd">                    **Hypothèse :** Plus d&#39;ingrédients = recette plus complexe et potentiellement dissuasive.</span>
<span class="sd">                    **Variable :** Nombre d&#39;ingrédients vs nombre d&#39;interactions.</span>
<span class="sd">                    **Analyse :** Impact de la richesse compositionnelle sur l&#39;engagement.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_pop_feat</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">popularity_vs_feature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                    <span class="c1"># Merge pour récupérer la note moyenne si disponible</span>
                    <span class="k">if</span> <span class="n">pop_rating</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Limiter les colonnes pour éviter suffixes _x / _y sur</span>
                        <span class="c1"># interaction_count</span>
                        <span class="n">pr_min</span> <span class="o">=</span> <span class="n">pop_rating</span><span class="p">[[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span> <span class="s2">&quot;avg_rating&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">merged</span> <span class="o">=</span> <span class="n">df_pop_feat</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pr_min</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">merged</span> <span class="o">=</span> <span class="n">df_pop_feat</span>
                    <span class="c1"># Normalisation de nom si interaction_count a été suffixé</span>
                    <span class="c1"># accidentellement</span>
                    <span class="k">if</span> <span class="s2">&quot;interaction_count_x&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;interaction_count&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interaction_count_x&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction_count&quot;</span><span class="p">},</span>
                            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;interaction_count_y&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;interaction_count&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interaction_count_y&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction_count&quot;</span><span class="p">},</span>
                            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">y_col</span> <span class="o">=</span> <span class="s2">&quot;interaction_count&quot;</span> <span class="k">if</span> <span class="s2">&quot;interaction_count&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;avg_rating&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plot</span><span class="p">(</span>
                            <span class="n">merged</span><span class="p">,</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span>
                            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                            <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
                            <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
                            <span class="n">bin_agg</span><span class="o">=</span><span class="n">bin_agg</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plot</span><span class="p">(</span>
                            <span class="n">merged</span><span class="p">,</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span>
                            <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
                            <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
                            <span class="n">bin_agg</span><span class="o">=</span><span class="n">bin_agg</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

                    <span class="c1"># Analyse narrative spécifique pour chaque caractéristique</span>
                    <span class="k">if</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        **Ce que révèle le graphique du temps :**</span>

<span class="sd">                        L&#39;analyse de la distribution révèle une concentration</span>
<span class="sd">                        de recettes bien notées dans certaines zones de temps, indiquant les &quot;sweet spots&quot;</span>
<span class="sd">                        temporels. Les recettes ultra-rapides (moins de 15 minutes) peuvent manquer de sophistication,</span>
<span class="sd">                        tandis que les préparations longues (plus de 2 heures) peuvent décourager les utilisateurs.</span>
<span class="sd">                        Les données suggèrent un équilibre entre temps suffisant pour créer de la valeur et durée raisonnable pour maintenir l&#39;engagement.</span>
<span class="sd">                        En regardant l&#39;histogramme avec suffisament de bins (&gt;30), on voit clairement que les recettes les plus refaites</span>
<span class="sd">                        sont les recettes prenant moins d&#39;une heure.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;n_steps&quot;</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        **Le verdict sur la complexité :**</span>

<span class="sd">                        L&#39;analyse révèle l&#39;un des paradoxes les plus significatifs de la cuisine.</span>
<span class="sd">                        Une concentration de recettes bien notées (gros points) autour de 5-8 étapes</span>
<span class="sd">                        confirme l&#39;existence d&#39;un &quot;niveau de défi optimal&quot;.</span>
<span class="sd">                        L&#39;engagement utilisateur optimal se situe entre</span>
<span class="sd">                        accomplissement satisfaisant et complexité gérable. Cette zone représente l&#39;équilibre</span>
<span class="sd">                        entre &quot;trop simple&quot;, &quot;ennuyeux&quot; et &quot;trop complexe&quot;,&quot;décourageant&quot;.</span>
<span class="sd">                        En regardant l&#39;histogramme avec suffisament de bins (&gt;30), on voit clairement que les recettes les plus refaites</span>
<span class="sd">                        sont les recettes ayant moins de 15 étapes environ.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">feat</span> <span class="o">==</span> <span class="s2">&quot;n_ingredients&quot;</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        **La révélation des ingrédients :**</span>

<span class="sd">                        L&#39;analyse révèle la relation entre nombre d&#39;ingrédients et satisfaction utilisateur.</span>
<span class="sd">                        Cette distribution montre comment la perception de &quot;richesse&quot; d&#39;une recette influence</span>
<span class="sd">                        son succès.</span>
<span class="sd">                        Les données révèlent un optimum entre richesse perçue</span>
<span class="sd">                        et accessibilité pratique. Un nombre trop faible d&#39;ingrédients peut sembler &quot;basique&quot;,</span>
<span class="sd">                        tandis qu&#39;un nombre excessif peut paraître &quot;intimidant&quot; ou &quot;coûteux&quot;.</span>
<span class="sd">                        La concentration des meilleures notes révèle le nombre optimal</span>
<span class="sd">                        qui équilibre richesse et accessibilité.</span>
<span class="sd">                        En regardant l&#39;histogramme avec suffisament de bins (&gt;30), on voit clairement que les recettes les plus refaites</span>
<span class="sd">                        sont les recettes demandant moins de 15 ingrédients environ.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aucune des colonnes minutes / n_steps / n_ingredients n&#39;est présente dans l&#39;agrégat.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_viral_recipe_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="p">:</span> <span class="n">InteractionsAnalyzer</span><span class="p">,</span>
        <span class="n">agg</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">interactions_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">recipes_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render temporal analysis of viral recipes with 3D visualization.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;📈 ÉTAPE 4 : Analyse temporelle&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Question :** Comment évoluent les recettes à fort engagement dans le temps ?</span>

<span class="sd">        Cette analyse examine l&#39;évolution temporelle de la qualité et du nombre d&#39;interactions</span>
<span class="sd">        pour les recettes du segment viral (&gt;95e percentile).</span>

<span class="sd">        **Approche :** Visualisation 3D des trajectoires temporelles pour identifier les phases</span>
<span class="sd">        d&#39;accélération de l&#39;engagement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Identify viral recipes</span>
        <span class="n">pop_rating</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">popularity_vs_rating</span><span class="p">()</span>
        <span class="n">segmented_data</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">create_popularity_segments</span><span class="p">(</span><span class="n">pop_rating</span><span class="p">)</span>
        <span class="n">viral_recipes</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="p">[</span><span class="n">segmented_data</span><span class="p">[</span><span class="s2">&quot;popularity_segment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Viral&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viral_recipes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Aucune recette virale détectée dans les données actuelles.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TOP 10 des recettes les plus virales</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 📋 Top 10 des recettes les plus virales&quot;</span><span class="p">)</span>

        <span class="c1"># Merge with recipe names and sort by interaction count</span>
        <span class="n">top_viral</span> <span class="o">=</span> <span class="n">viral_recipes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">recipes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">top_viral</span> <span class="o">=</span> <span class="n">top_viral</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">recipes_df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]],</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span>
                <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Sort by interaction count (most viral first) and take top 10</span>
        <span class="n">top_viral</span> <span class="o">=</span> <span class="n">top_viral</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Recalculer les stats avec les mêmes filtres que le graphique 3D</span>

        <span class="c1"># Recalculate stats using only complete data (same as 3D graph)</span>
        <span class="n">corrected_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_viral</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">recipe_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span>
            <span class="n">recipe_interactions</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Apply same filtering as 3D graph</span>
                <span class="n">date_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;date&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">date_columns</span><span class="p">:</span>
                    <span class="n">date_col</span> <span class="o">=</span> <span class="n">date_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">complete_data</span> <span class="o">=</span> <span class="n">recipe_interactions</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">date_col</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">corrected_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;recipe_id&quot;</span><span class="p">:</span> <span class="n">recipe_id</span><span class="p">,</span>
                                <span class="s2">&quot;interaction_count_filtered&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">),</span>
                                <span class="s2">&quot;avg_rating_filtered&quot;</span><span class="p">:</span> <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Recipe </span><span class="si">{</span><span class="n">recipe_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

        <span class="c1"># Create corrected display dataframe</span>
        <span class="k">if</span> <span class="n">corrected_stats</span><span class="p">:</span>
            <span class="n">corrected_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corrected_stats</span><span class="p">)</span>
            <span class="n">corrected_df</span> <span class="o">=</span> <span class="n">corrected_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;interaction_count_filtered&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interaction_count_filtered&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avg_rating_filtered&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">top_viral_display</span> <span class="o">=</span> <span class="n">corrected_df</span><span class="p">[</span><span class="n">display_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">top_viral_display</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Nom de la recette&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ID&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nb interactions (dates valides)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Note moyenne (dates valides)&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to original data if no corrected data available</span>
            <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span> <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span> <span class="s2">&quot;avg_rating&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">top_viral</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span> <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span> <span class="s2">&quot;avg_rating&quot;</span><span class="p">]</span>

            <span class="n">top_viral_display</span> <span class="o">=</span> <span class="n">top_viral</span><span class="p">[</span><span class="n">display_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">top_viral_display</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;Nom de la recette&quot;</span><span class="p">,</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Nb interactions&quot;</span><span class="p">,</span> <span class="s2">&quot;Note moyenne&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">top_viral</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Nb interactions&quot;</span><span class="p">,</span> <span class="s2">&quot;Note moyenne&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Add rank column</span>
        <span class="n">top_viral_display</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Rang&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_viral_display</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Format the display</span>
        <span class="k">if</span> <span class="s2">&quot;Nom de la recette&quot;</span> <span class="ow">in</span> <span class="n">top_viral_display</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">top_viral_display</span><span class="p">[</span><span class="s2">&quot;Nom de la recette&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_viral_display</span><span class="p">[</span><span class="s2">&quot;Nom de la recette&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">60</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Format interaction count column (handle both old and new column names)</span>
        <span class="n">interaction_col</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">top_viral_display</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;interactions&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">interaction_col</span><span class="p">:</span>
            <span class="n">top_viral_display</span><span class="p">[</span><span class="n">interaction_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_viral_display</span><span class="p">[</span><span class="n">interaction_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Format rating column (handle both old and new column names)</span>
        <span class="n">rating_col</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">top_viral_display</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;note moyenne&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rating_col</span><span class="p">:</span>
            <span class="n">top_viral_display</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_viral_display</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ⭐&quot;</span><span class="p">)</span>

        <span class="c1"># Display the table</span>
        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">top_viral_display</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;stretch&quot;</span><span class="p">,</span> <span class="n">hide_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Quick stats</span>
        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
                <span class="s2">&quot;🥇 Recette #1&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_viral</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;interaction_count&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> interactions&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="n">total_interactions</span> <span class="o">=</span> <span class="n">top_viral</span><span class="p">[</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;📊 Total Top 10&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_interactions</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> interactions&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col3</span><span class="p">:</span>
            <span class="n">avg_rating_top10</span> <span class="o">=</span> <span class="n">top_viral</span><span class="p">[</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;⭐ Note moyenne&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_rating_top10</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Recipe selection interface for 3D analysis</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 📋 Pattern Commun du Top 3&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Observation du pattern commun sur les recettes les plus populaires :**</span>

<span class="sd">        En analysant le top 3 des recettes virales, nous observons un **pattern commun** :</span>
<span class="sd">        - **Phase 1** : Croissance progressive par effet boule de neige</span>
<span class="sd">        - **Phase 2** : Forte accélération quand la recette devient tendance</span>
<span class="sd">        - **Phase 3** : Stagnation puis déclin quand la mode passe</span>

<span class="sd">        Ce phénomène reflète le cycle naturel des tendances culinaires.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Sélection du top 3 pour illustrer le pattern commun</span>
        <span class="n">representative_examples</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;top_1&quot;</span><span class="p">:</span> <span class="mi">2886</span><span class="p">,</span>  <span class="c1"># best banana bread - #1 des interactions</span>
            <span class="s2">&quot;top_2&quot;</span><span class="p">:</span> <span class="mi">27208</span><span class="p">,</span>  <span class="c1"># to die for crock pot roast - #2 des interactions</span>
            <span class="s2">&quot;top_3&quot;</span><span class="p">:</span> <span class="mi">39087</span><span class="p">,</span>  <span class="c1"># creamy cajun chicken pasta - #3 des interactions</span>
        <span class="p">}</span>

        <span class="c1"># Afficher le tableau des exemples sélectionnés</span>
        <span class="n">examples_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">recipe_id</span> <span class="ow">in</span> <span class="n">representative_examples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Chercher dans les données</span>
            <span class="n">recipe_interactions</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">recipe_name</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">recipes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">recipe_match</span> <span class="o">=</span> <span class="n">recipes_df</span><span class="p">[</span><span class="n">recipes_df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">recipe_name</span> <span class="o">=</span> <span class="n">recipe_match</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Calculer les stats pour cet exemple</span>
                <span class="n">avg_rating</span> <span class="o">=</span> <span class="n">recipe_interactions</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">total_interactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span>

                <span class="n">examples_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Rang&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">representative_examples</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">recipe_id</span><span class="p">,</span>
                        <span class="s2">&quot;Nom&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">recipe_name</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">recipe_name</span><span class="p">),</span>
                        <span class="s2">&quot;Interactions&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_interactions</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Note Moyenne&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_rating</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ⭐&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">examples_data</span><span class="p">:</span>
            <span class="n">examples_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">examples_data</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">examples_df</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;stretch&quot;</span><span class="p">,</span> <span class="n">hide_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Utiliser ces exemples pour la visualisation 3D</span>
        <span class="n">selected_recipe_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">representative_examples</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">recipe_display</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">examples_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Nom&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">representative_examples</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">selected_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_recipe_ids</span><span class="p">)))</span>

        <span class="c1"># Temporal analysis</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 📊 Visualisation 3D du Pattern Commun&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Lecture du graphique :**</span>
<span class="sd">        - **X** : Date de l&#39;interaction</span>
<span class="sd">        - **Y** : Note attribuée (1-5 étoiles)</span>
<span class="sd">        - **Z** : Densité d&#39;interactions (nombre d&#39;avis par période)</span>

<span class="sd">        🔍 **L&#39;effet boule de neige** : démarrage lent, accélération, puis stabilisation/déclin</span>

<span class="sd">        **Note :** La visualisation 3D utilise les données brutes pour préserver toutes les recettes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create 3D visualization using RAW data to preserve all recipes</span>
        <span class="c1"># Note: 3D visualization shows actual recipe trajectories without preprocessing</span>
        <span class="c1"># to ensure no recipes are excluded from visualization</span>
        <span class="c1"># IMPROVEMENT: Enhanced temporal sampling for smoother trajectories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using raw data for 3D visualization with improved temporal sampling&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_3d_visualization_real</span><span class="p">(</span><span class="n">selected_recipe_ids</span><span class="p">,</span> <span class="n">interactions_df</span><span class="p">,</span> <span class="n">recipe_display</span><span class="p">,</span> <span class="n">selected_indices</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_3d_visualization_real</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">recipe_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">interactions_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">recipe_display</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">selected_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create 3D visualization with real temporal data from the dataset.&quot;&quot;&quot;</span>

        <span class="c1"># Check for available date columns</span>
        <span class="n">date_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;date&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">date_columns</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Aucune colonne de date trouvée. Colonnes disponibles : &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">interactions_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="k">return</span>

        <span class="c1"># Use the first date column found, or let user choose if multiple</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">date_col</span> <span class="o">=</span> <span class="n">date_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colonnes de date disponibles : </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">date_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">date_col</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Choisissez la colonne de date :&quot;</span><span class="p">,</span> <span class="n">date_columns</span><span class="p">)</span>

        <span class="c1"># Ensure date column is in datetime format</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interactions_df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="n">date_col</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur lors de la conversion de la colonne &#39;</span><span class="si">{</span><span class="n">date_col</span><span class="si">}</span><span class="s2">&#39; en date : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Add interval selection for temporal sampling</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;⚙️ Paramètres temporels&quot;</span><span class="p">)</span>
        <span class="n">interval_days</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
            <span class="s2">&quot;Afficher un point tous les :&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Default: tous les 7 jours</span>
            <span class="n">format_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> jour</span><span class="si">{</span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">30</span><span class="si">}</span><span class="s2"> mois&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#FF6B6B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#4ECDC4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#DDA0DD&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#45B7D1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#96CEB4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FFEAA7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#98D8C8&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">recipe_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recipe_ids</span><span class="p">):</span>
            <span class="c1"># Filter interactions for this recipe</span>
            <span class="n">recipe_interactions</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Ensure date column is properly converted to datetime</span>
            <span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

            <span class="c1"># Filter out rows with missing essential data (date, rating, recipe_id)</span>
            <span class="n">complete_data</span> <span class="o">=</span> <span class="n">recipe_interactions</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">date_col</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aucune donnée complète trouvée pour la recette </span><span class="si">{</span><span class="n">recipe_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Sort by date to ensure strict chronological order</span>
            <span class="n">complete_data</span> <span class="o">=</span> <span class="n">complete_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Convert dates to numeric for plotting (days since first interaction)</span>
            <span class="n">first_date</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>

            <span class="c1"># Filter based on temporal interval (every X days) - IMPROVED SAMPLING</span>
            <span class="k">if</span> <span class="n">interval_days</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Group by interval periods and take a representative point</span>
                <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="n">interval_days</span>

                <span class="c1"># Take the point closest to the middle of each period for better</span>
                <span class="c1"># representation</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">get_middle_point</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
                    <span class="n">period_start</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">period_end</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">period_middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_start</span> <span class="o">+</span> <span class="n">period_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="c1"># Find the interaction closest to the middle of the period</span>
                    <span class="n">closest_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">period_middle</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">closest_idx</span><span class="p">]</span>

                <span class="n">display_data</span> <span class="o">=</span> <span class="n">complete_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_middle_point</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Show ALL points (every single interaction)</span>
                <span class="n">display_data</span> <span class="o">=</span> <span class="n">complete_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Calculate cumulative statistics correctly</span>
            <span class="n">display_data</span> <span class="o">=</span> <span class="n">display_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># For each point, calculate the cumulative average rating from ALL</span>
            <span class="c1"># previous interactions</span>
            <span class="n">cumulative_avg_ratings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cumulative_interactions</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">display_data</span><span class="p">)):</span>
                <span class="n">current_day</span> <span class="o">=</span> <span class="n">display_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span>
                <span class="c1"># Get all interactions up to and including current day from original</span>
                <span class="c1"># complete_data</span>
                <span class="n">interactions_up_to_day</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">current_day</span><span class="p">]</span>

                <span class="c1"># Calculate cumulative average rating (from day 1 to current day)</span>
                <span class="n">cumulative_avg_rating</span> <span class="o">=</span> <span class="n">interactions_up_to_day</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">cumulative_avg_ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cumulative_avg_rating</span><span class="p">)</span>

                <span class="c1"># Cumulative interaction count</span>
                <span class="n">cumulative_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interactions_up_to_day</span><span class="p">))</span>

            <span class="n">display_data</span><span class="p">[</span><span class="s2">&quot;cumulative_avg_rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_avg_ratings</span>
            <span class="n">display_data</span><span class="p">[</span><span class="s2">&quot;cumulative_interactions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_interactions</span>

            <span class="c1"># Extract coordinates for 3D plot - only real data points</span>
            <span class="n">x_dates</span> <span class="o">=</span> <span class="n">display_data</span><span class="p">[</span><span class="s2">&quot;days_since_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y_ratings</span> <span class="o">=</span> <span class="n">display_data</span><span class="p">[</span><span class="s2">&quot;cumulative_avg_rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Cumulative average ratings</span>
            <span class="n">z_cumulative</span> <span class="o">=</span> <span class="n">display_data</span><span class="p">[</span><span class="s2">&quot;cumulative_interactions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Ensure we have valid data to plot</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_dates</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_ratings</span><span class="p">)):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Données invalides pour la recette </span><span class="si">{</span><span class="n">recipe_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Plot the 3D trajectory</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_dates</span><span class="p">,</span>
                <span class="n">y_ratings</span><span class="p">,</span>
                <span class="n">z_cumulative</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]][:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">30</span>
                    <span class="k">else</span> <span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="p">),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add trajectory start and end markers</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_dates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Start point (green)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">y_ratings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">z_cumulative</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># End point (red)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Add dotted lines to show final coordinates instead of projections</span>
                <span class="c1"># Vertical line from bottom to final point</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="s2">&quot;k--&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Horizontal line from Y-axis to final point</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="s2">&quot;k--&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Line from X-axis to final point</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_ratings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_cumulative</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="s2">&quot;k--&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Formatting and labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Jours depuis la première interaction&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Note moyenne cumulative&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Interactions cumulées&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Évolution Temporelle des Recettes Virales&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="c1"># Set explicit axis limits to ensure correct scaling</span>
        <span class="c1"># Collect all data points to determine proper axis limits</span>
        <span class="n">all_x</span><span class="p">,</span> <span class="n">all_y</span><span class="p">,</span> <span class="n">all_z</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">recipe_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recipe_ids</span><span class="p">):</span>
            <span class="n">recipe_interactions</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">date_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;date&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">date_columns</span><span class="p">:</span>
                    <span class="n">date_col</span> <span class="o">=</span> <span class="n">date_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">complete_data</span> <span class="o">=</span> <span class="n">recipe_interactions</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">date_col</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Calculate actual final values</span>
                        <span class="n">complete_data</span> <span class="o">=</span> <span class="n">complete_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span>
                        <span class="n">first_date</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">final_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">first_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
                        <span class="n">final_rating</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Overall average</span>
                        <span class="n">final_interactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span>

                        <span class="n">all_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_days</span><span class="p">)</span>
                        <span class="n">all_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_rating</span><span class="p">)</span>
                        <span class="n">all_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_interactions</span><span class="p">)</span>

        <span class="c1"># Set axis limits with some padding</span>
        <span class="k">if</span> <span class="n">all_x</span> <span class="ow">and</span> <span class="n">all_y</span> <span class="ow">and</span> <span class="n">all_z</span><span class="p">:</span>
            <span class="n">x_margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
            <span class="n">z_margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_z</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_margin</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Note moyenne toujours de 0 à 5 pour référence standardisée</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">z_margin</span><span class="p">)</span>

        <span class="c1"># Disable default shadow projections on XZ and YZ planes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Make panes transparent</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Legend with custom positioning</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Recettes&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">})</span>

        <span class="c1"># Add grid for better readability</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Custom viewing angle for better perspective</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Analysis Summary</span>
        <span class="c1"># Legend and axes explanation</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;📊 Lecture du graphique&quot;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            **Légende :**</span>
<span class="sd">            - 🟢 Point de démarrage - 🔴 Point final</span>
<span class="sd">            - Lignes pointillées : repères pour lecture des coordonnées</span>

<span class="sd">            **Axes d&#39;analyse :**</span>
<span class="sd">            - **X** : Temps (jours depuis première interaction)</span>
<span class="sd">            - **Y** : Qualité cumulative (note moyenne évolutive)</span>
<span class="sd">            - **Z** : Volume d&#39;adoption (interactions cumulées)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 💡 Analyse Synthétique : Le Pattern Universel du Succès&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Analyse morphologique des trajectoires 3D :** L&#39;examen des courbures et dérivées révèle une</span>
<span class="sd">        signature temporelle commune correspondant au cycle naturel des tendances virales.</span>

<span class="sd">        **Pattern universel identifié :**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Single unified analysis about the common pattern</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **📈 Pattern Universel - Effet Boule de Neige**</span>

<span class="sd">        **Morphologie observée sur les 3 recettes les plus virales :**</span>
<span class="sd">        - **Phase 1** : Accumulation lente (dZ/dt faible) - période d&#39;émergence</span>
<span class="sd">        - **Phase 2** : Accélération massive (d²Z/dt² &gt; 0) - explosion virale</span>
<span class="sd">        - **Phase 3** : Plateau puis déclin possible à prévoir (dZ/dt → 0 puis négatif) - fin de mode</span>

<span class="sd">        **Explication simple :** Comme toute tendance, les recettes virales suivent</span>
<span class="sd">        le même cycle : émergence discrète, explosion quand elles deviennent &quot;à la mode&quot;,</span>
<span class="sd">        puis retour progressif à la normale quand l&#39;effet de nouveauté s&#39;estompe.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Display detailed statistics</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### 📊 Statistiques par recette&quot;</span><span class="p">)</span>

        <span class="n">stats_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">recipe_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recipe_ids</span><span class="p">):</span>
            <span class="n">recipe_interactions</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s2">&quot;recipe_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">recipe_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Filter only complete data (same logic as 3D plot)</span>
                <span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">recipe_interactions</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                <span class="n">complete_data</span> <span class="o">=</span> <span class="n">recipe_interactions</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">date_col</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">first_interaction</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">last_interaction</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_interaction</span> <span class="o">-</span> <span class="n">first_interaction</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
                    <span class="n">total_interactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete_data</span><span class="p">)</span>
                    <span class="n">avg_rating</span> <span class="o">=</span> <span class="n">complete_data</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                    <span class="n">stats_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">recipe_id</span><span class="p">,</span>
                            <span class="s2">&quot;Recette&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]][:</span><span class="mi">40</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">40</span>
                                <span class="k">else</span> <span class="n">recipe_display</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;Première interaction&quot;</span><span class="p">:</span> <span class="n">first_interaction</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;Dernière interaction&quot;</span><span class="p">:</span> <span class="n">last_interaction</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;Durée (jours)&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                            <span class="s2">&quot;Total interactions (complètes)&quot;</span><span class="p">:</span> <span class="n">total_interactions</span><span class="p">,</span>
                            <span class="s2">&quot;Note moyenne&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_rating</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Interactions/jour&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_interactions</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">stats_data</span><span class="p">:</span>
            <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats_data</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;stretch&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------- Data Loading ---------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="n">inter_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interactions_path</span><span class="p">)</span>
        <span class="n">rec_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recipes_path</span><span class="p">)</span>
        <span class="n">interactions_df</span> <span class="o">=</span> <span class="n">inter_loader</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="n">recipes_df</span> <span class="o">=</span> <span class="n">rec_loader</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">interactions_df</span><span class="p">,</span> <span class="n">recipes_df</span>

    <span class="c1"># ---------------- Visualization helpers ---------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get predefined French titles based on plot type and variables.&quot;&quot;&quot;</span>

        <span class="c1"># Titres prédéfinis pour les graphiques les plus courants</span>
        <span class="n">predefined_titles</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Scatter plots</span>
            <span class="p">(</span>
                <span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Note moyenne selon le nombre d&#39;interactions&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Nombre d&#39;interactions selon la note moyenne&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;minutes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Note moyenne selon la durée de préparation&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;n_steps&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Note moyenne selon le nombre d&#39;étapes&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;n_ingredients&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Note moyenne selon le nombre d&#39;ingrédients&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;minutes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Nombre d&#39;interactions selon la durée de préparation&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;n_steps&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Nombre d&#39;interactions selon le nombre d&#39;étapes&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;n_ingredients&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Nombre d&#39;interactions selon le nombre d&#39;ingrédients&quot;</span><span class="p">,</span>
            <span class="c1"># Histograms avec count</span>
            <span class="p">(</span><span class="s2">&quot;avg_rating&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">):</span> <span class="s2">&quot;Distribution des notes moyennes&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Histogram&quot;</span><span class="p">,</span>
            <span class="p">):</span> <span class="s2">&quot;Distribution du nombre d&#39;interactions&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">):</span> <span class="s2">&quot;Distribution des durées de préparation&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;n_steps&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">):</span> <span class="s2">&quot;Distribution du nombre d&#39;étapes&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;n_ingredients&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">):</span> <span class="s2">&quot;Distribution du nombre d&#39;ingrédients&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">):</span> <span class="s2">&quot;Distribution des notes&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Recherche du titre prédéfini</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">predefined_titles</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predefined_titles</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Titre par défaut pour les histogrammes</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">:</span>
            <span class="n">key_hist</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_hist</span> <span class="ow">in</span> <span class="n">predefined_titles</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">predefined_titles</span><span class="p">[</span><span class="n">key_hist</span><span class="p">]</span>

        <span class="c1"># Fallback : génération simple</span>
        <span class="n">var_labels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;avg_rating&quot;</span><span class="p">:</span> <span class="s2">&quot;Note moyenne&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;interactions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minutes&quot;</span><span class="p">:</span> <span class="s2">&quot;Durée (minutes)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_steps&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;étapes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_ingredients&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;ingrédients&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="s2">&quot;Note&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">x_label</span> <span class="o">=</span> <span class="n">var_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">var_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Distribution de </span><span class="si">{</span><span class="n">x_label</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Scatter</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y_label</span><span class="si">}</span><span class="s2"> selon </span><span class="si">{</span><span class="n">x_label</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Scatter&quot;</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">bin_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create plot based on selected type with improved visualization.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Scatter&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_histogram_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">bin_agg</span><span class="p">)</span>

        <span class="c1"># Utiliser un titre prédéfini si aucun titre n&#39;est fourni</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_title</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">bin_agg</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="c1"># Labels des axes en français</span>
        <span class="n">var_labels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;avg_rating&quot;</span><span class="p">:</span> <span class="s2">&quot;Note moyenne&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;interactions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minutes&quot;</span><span class="p">:</span> <span class="s2">&quot;Durée (minutes)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_steps&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;étapes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_ingredients&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre d&#39;ingrédients&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="s2">&quot;Note&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">x_label</span> <span class="o">=</span> <span class="n">var_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">var_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>

        <span class="c1"># Pour les histogrammes, l&#39;axe Y affiche toujours le nombre d&#39;observations</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Nombre d&#39;observations&quot;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_scatter_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced scatter plot with all data points displayed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Plot all data points without sampling</span>
            <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">],</span>
                <span class="n">s</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># Scale size</span>
                <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="c1"># Label plus explicite pour la colorbar</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="s2">&quot;avg_rating&quot;</span><span class="p">:</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Moyenne des notes&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size_label</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">size_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot all data points without sampling</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_histogram_plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bin_agg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create histogram counting observations per bin.&quot;&quot;&quot;</span>
        <span class="c1"># Create bins for x-axis</span>
        <span class="n">data_clean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_clean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;Pas de données valides&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create proper bins with explicit edges</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">data_clean</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data_clean</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Assign each point to a bin</span>
        <span class="n">data_clean</span> <span class="o">=</span> <span class="n">data_clean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_clean</span><span class="p">[</span><span class="s2">&quot;bin_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data_clean</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Calculate bin centers for plotting</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_bins</span>

        <span class="c1"># Count observations per bin</span>
        <span class="n">agg_data</span> <span class="o">=</span> <span class="n">data_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;bin_idx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
        <span class="n">y_values</span> <span class="o">=</span> <span class="n">agg_data</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Nombre d&#39;observations&quot;</span>

        <span class="c1"># Handle size aggregation if provided (count observations with that size)</span>
        <span class="n">size_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">data_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">size_agg</span> <span class="o">=</span> <span class="n">data_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;bin_idx&quot;</span><span class="p">)[</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Moyenne de la variable size par bin</span>

            <span class="c1"># Align with y_values</span>
            <span class="n">size_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">agg_data</span><span class="p">[</span><span class="s2">&quot;bin_idx&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">size_agg</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">size_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size_agg</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">size_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create the bar plot</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">agg_data</span><span class="p">[</span><span class="s2">&quot;bin_idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">plot_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">bin_centers</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">valid_indices</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)]</span>
        <span class="n">plot_y</span> <span class="o">=</span> <span class="n">y_values</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_x</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">size_values</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_x</span><span class="p">):</span>
            <span class="c1"># Color bars by size value using the same colormap as scatter plots</span>
            <span class="n">size_plot</span> <span class="o">=</span> <span class="n">size_values</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_x</span><span class="p">)]</span>

            <span class="c1"># Normalize size values for coloring</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">size_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">size_plot</span><span class="p">):</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">size_plot</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">size_plot</span><span class="p">))</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size_plot</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;steelblue&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_x</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">plot_x</span><span class="p">,</span>
                <span class="n">plot_y</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add colorbar consistent with scatter plots</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">size_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">size_plot</span><span class="p">):</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

                <span class="c1"># Label plus explicite pour la colorbar</span>
                <span class="n">size_label</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="s2">&quot;avg_rating&quot;</span><span class="p">:</span>
                    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Moyenne des notes (du bin)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moyenne </span><span class="si">{</span><span class="n">size_label</span><span class="si">}</span><span class="s2"> (du bin)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Simple histogram without size coloring</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">plot_x</span><span class="p">,</span>
                <span class="n">plot_y</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add value labels on top of bars (more readable)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span> <span class="n">plot_y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x_pos</span><span class="p">,</span>
                    <span class="n">height</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                    <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Improve axis labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="c1"># Set proper x-axis limits and ticks</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span> <span class="o">-</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">+</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Add subtle grid for better readability</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------- Main Render ---------------- #</span>
<div class="viewcode-block" id="PopularityAnalysisPage.run">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.popularity_analysis_page.PopularityAnalysisPage.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Introduction analytique</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;🎯 Objectifs et méthodologie de l&#39;analyse&quot;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ### Qu&#39;est-ce qui rend une recette populaire ?</span>

<span class="sd">            Cette analyse explore la relation entre la qualité des recettes (notes des utilisateurs) et leur</span>
<span class="sd">            succès (nombre d&#39;interactions soit le nombre d&#39;utilisateur ayant review la recette). Nous examinons comment les caractéristiques des recettes influencent</span>
<span class="sd">            leur adoption par la communauté.</span>

<span class="sd">            **Questions centrales :** La qualité garantit-elle la popularité ? Quels sont les facteurs</span>
<span class="sd">            déterminants du succès d&#39;une recette ? Existe-t-il des profils de recettes particulièrement</span>
<span class="sd">            attractifs ?</span>

<span class="sd">            **Approche :** Analyse comparative entre qualité et engagement, segmentation des recettes par</span>
<span class="sd">            popularité, identification des caractéristiques discriminantes.</span>

<span class="sd">            **Données :** Preprocessing sélectif qui conserve toutes les interactions authentiques tout en</span>
<span class="sd">            filtrant les anomalies techniques (seuil configurable dans la barre latérale).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Section explicative du preprocessing (cachée par défaut)</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;⚙️ Choix et justification du preprocessing&quot;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ### Pourquoi un preprocessing sélectif ?</span>

<span class="sd">            Le preprocessing appliqué vise à préserver l&#39;authenticité des données tout en éliminant</span>
<span class="sd">            les artefacts techniques qui fausseraient l&#39;analyse.</span>

<span class="sd">            **Principe directeur :** Conserver toutes les interactions légitimes, filtrer uniquement</span>
<span class="sd">            les anomalies techniques évidentes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Vérification en temps réel des valeurs manquantes</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;#### 🔍 Vérification des valeurs manquantes&quot;</span><span class="p">)</span>

            <span class="c1"># Chargement temporaire pour vérification</span>
            <span class="n">temp_interactions_df</span><span class="p">,</span> <span class="n">temp_recipes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>

            <span class="c1"># Analyse des valeurs manquantes dans les colonnes critiques pour l&#39;analyse</span>
            <span class="c1"># Ajout dynamique de la/les colonne(s) de date si présente(s)</span>
            <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;date&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="n">critical_interactions_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;recipe_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">date_cols</span>
            <span class="n">critical_recipes_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;n_steps&quot;</span><span class="p">,</span> <span class="s2">&quot;n_ingredients&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">]</span>

            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;**🎯 Colonnes critiques (interactions) :**&quot;</span><span class="p">)</span>
                <span class="n">interactions_critical_missing</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">critical_interactions_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">missing</span> <span class="o">=</span> <span class="n">temp_interactions_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">interactions_critical_missing</span> <span class="o">+=</span> <span class="n">missing</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">missing</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">`: </span><span class="si">{</span><span class="n">missing</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> manquantes&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ `</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">`: colonne absente&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">interactions_critical_missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;✅ Toutes les colonnes critiques sont complètes&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">interactions_critical_missing</span><span class="si">}</span><span class="s2"> valeurs manquantes dans les colonnes critiques&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;**🎯 Colonnes critiques (recettes) :**&quot;</span><span class="p">)</span>
                <span class="n">recipes_critical_missing</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">critical_recipes_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">temp_recipes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">missing</span> <span class="o">=</span> <span class="n">temp_recipes_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">recipes_critical_missing</span> <span class="o">+=</span> <span class="n">missing</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">missing</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">`: </span><span class="si">{</span><span class="n">missing</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> manquantes&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ `</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">`: colonne absente&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">recipes_critical_missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;✅ Toutes les colonnes critiques sont complètes&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">recipes_critical_missing</span><span class="si">}</span><span class="s2"> valeurs manquantes dans les colonnes critiques&quot;</span><span class="p">)</span>

            <span class="c1"># Analyse complète (toutes colonnes)</span>
            <span class="n">interactions_total_missing</span> <span class="o">=</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">recipes_total_missing</span> <span class="o">=</span> <span class="n">temp_recipes_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;📊 Analyse complète de toutes les colonnes&quot;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;**Fichier interactions :**&quot;</span><span class="p">)</span>
                    <span class="n">interactions_missing</span> <span class="o">=</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">interactions_total_missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;✅ Aucune valeur manquante&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ℹ️ </span><span class="si">{</span><span class="n">interactions_total_missing</span><span class="si">}</span><span class="s2"> valeurs manquantes (colonnes non-critiques)&quot;</span><span class="p">)</span>
                        <span class="n">missing_details</span> <span class="o">=</span> <span class="n">interactions_missing</span><span class="p">[</span><span class="n">interactions_missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_details</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">missing_details</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

                <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;**Fichier recettes :**&quot;</span><span class="p">)</span>
                    <span class="n">recipes_missing</span> <span class="o">=</span> <span class="n">temp_recipes_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">recipes_total_missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;✅ Aucune valeur manquante&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ℹ️ </span><span class="si">{</span><span class="n">recipes_total_missing</span><span class="si">}</span><span class="s2"> valeurs manquantes (colonnes non-critiques)&quot;</span><span class="p">)</span>
                        <span class="n">missing_details</span> <span class="o">=</span> <span class="n">recipes_missing</span><span class="p">[</span><span class="n">recipes_missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_details</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">missing_details</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

            <span class="c1"># Conclusion sur la nécessité du KNN</span>
            <span class="n">total_critical_missing</span> <span class="o">=</span> <span class="n">interactions_critical_missing</span> <span class="o">+</span> <span class="n">recipes_critical_missing</span>
            <span class="k">if</span> <span class="n">total_critical_missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                **🎯 Conclusion :** Aucune valeur manquante dans les colonnes critiques pour l&#39;analyse numérique.</span>

<span class="sd">                ✅ **KNN imputation non nécessaire** - toutes les données numériques (rating, minutes, n_steps, n_ingredients) sont complètes.</span>

<span class="sd">                ℹ️ Les valeurs manquantes détectées sont dans des colonnes textuelles (review, description) non utilisées dans les calculs.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                **⚠️ Attention :** Des valeurs manquantes existent dans les colonnes critiques.</span>

<span class="sd">                🔧 **KNN imputation recommandée** pour maintenir l&#39;intégrité de l&#39;analyse.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Statistiques globales</span>
            <span class="n">total_cells_interactions</span> <span class="o">=</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp_interactions_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total_cells_recipes</span> <span class="o">=</span> <span class="n">temp_recipes_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp_recipes_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total_missing</span> <span class="o">=</span> <span class="n">interactions_total_missing</span> <span class="o">+</span> <span class="n">recipes_total_missing</span>
            <span class="n">total_cells</span> <span class="o">=</span> <span class="n">total_cells_interactions</span> <span class="o">+</span> <span class="n">total_cells_recipes</span>

            <span class="p">((</span><span class="n">total_cells</span> <span class="o">-</span> <span class="n">total_missing</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_cells</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            **🔧 Méthode IQR (Interquartile Range) :**</span>
<span class="sd">            - **Seuil configurable** : 1.0 à 20.0 (par défaut : 10.0)</span>
<span class="sd">            - **Calcul** : Q1 - seuil×IQR ≤ valeurs ≤ Q3 + seuil×IQR</span>
<span class="sd">            - **Cibles** : Variables numériques continues (temps, étapes, ingrédients)</span>

<span class="sd">            **Ce qui est préservé :**</span>
<span class="sd">            - **Toutes les notes utilisateurs** (aucun filtrage sur les ratings)</span>
<span class="sd">            - **Toutes les interactions datées** (comportements authentiques)</span>
<span class="sd">            - **Recettes avec caractéristiques extrêmes mais plausibles**</span>

<span class="sd">            **Impact typique :** 80-99% des données conservées selon le seuil choisi.</span>
<span class="sd">            Le seuil est ajustable dans la barre latérale pour explorer différents niveaux de filtrage.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sidebar</span><span class="p">()</span>
        <span class="n">plot_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;plot_type&quot;</span><span class="p">]</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_bins&quot;</span><span class="p">]</span>
        <span class="n">bin_agg</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;bin_agg&quot;</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
        <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;outlier_threshold&quot;</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Chargement des données...&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading data for popularity analysis&quot;</span><span class="p">)</span>
            <span class="n">interactions_df</span><span class="p">,</span> <span class="n">recipes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Loaded interactions: </span><span class="si">{</span><span class="n">interactions_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, recipes: </span><span class="si">{</span><span class="n">recipes_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Configuration preprocessing sélective : filtrer les valeurs techniques</span>
        <span class="c1"># aberrantes mais garder toutes les notes</span>
        <span class="n">config_selective</span> <span class="o">=</span> <span class="n">PreprocessingConfig</span><span class="p">(</span>
            <span class="n">enable_preprocessing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">outlier_method</span><span class="o">=</span><span class="s2">&quot;iqr&quot;</span><span class="p">,</span>  <span class="c1"># Méthode IQR avec seuil configurable</span>
            <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span>  <span class="c1"># Seuil configuré via sidebar</span>
        <span class="p">)</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">InteractionsAnalyzer</span><span class="p">(</span>
            <span class="n">interactions</span><span class="o">=</span><span class="n">interactions_df</span><span class="p">,</span>
            <span class="n">recipes</span><span class="o">=</span><span class="n">recipes_df</span><span class="p">,</span>
            <span class="n">preprocessing</span><span class="o">=</span><span class="n">config_selective</span><span class="p">,</span>
            <span class="n">cache_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Cache activé pour de meilleures performances</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized InteractionsAnalyzer with preprocessing threshold </span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Affichage de l&#39;impact du preprocessing avec détails statistiques</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_df</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">)</span>
            <span class="n">filtered_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
            <span class="n">filtered_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">filtered_count</span> <span class="o">/</span> <span class="n">original_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="c1"># Récupération des stats de preprocessing</span>
            <span class="n">preprocessing_stats</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">get_preprocessing_stats</span><span class="p">()</span>

            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
                    <span class="s2">&quot;📊 Observations conservées&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filtered_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filtered_percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% du total&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
                    <span class="s2">&quot;⚙️ Seuil IQR actuel&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Multiplicateur appliqué à l&#39;écart interquartile&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Détails des features traitées</span>
            <span class="k">if</span> <span class="n">preprocessing_stats</span> <span class="ow">and</span> <span class="s2">&quot;features_processed&quot;</span> <span class="ow">in</span> <span class="n">preprocessing_stats</span><span class="p">:</span>
                <span class="n">features_processed</span> <span class="o">=</span> <span class="n">preprocessing_stats</span><span class="p">[</span><span class="s2">&quot;features_processed&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">features_processed</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Features analysées :** </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features_processed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Preprocessing** (seuil </span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) - Détails non disponibles: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Cache management in sidebar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_cache_controls</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>

        <span class="n">agg</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">aggregate</span><span class="p">()</span>

        <span class="c1"># Aperçu du dataframe fusionné avant agrégation</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Aperçu du dataframe fusionné (interactions ⟵ recettes)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">_df</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Lignes&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Colonnes&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Colonnes du merged df&quot;</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Impossible d&#39;afficher le merged df: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Table d&#39;agrégation (Top 20)&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>

        <span class="c1"># Execute the 4 analysis steps using dedicated render methods</span>
        <span class="n">pop_rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_1</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">bin_agg</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pop_rating</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_2</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">pop_rating</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_3</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">bin_agg</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">pop_rating</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_viral_recipe_analysis</span><span class="p">(</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">interactions_df</span><span class="p">,</span> <span class="n">recipes_df</span><span class="p">)</span>

        <span class="c1"># Synthèse et conclusions</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;📋 Synthèse des résultats&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ### Conclusions principales</span>

<span class="sd">        **1. Relation qualité-popularité :** Non-linéaire avec formation de clusters distincts</span>
<span class="sd">        selon le niveau d&#39;engagement, confirmant que l&#39;excellence seule ne garantit pas la viralité.</span>

<span class="sd">        **2. Segmentation comportementale :** Segmentation par percentiles révélant 4 segments</span>
<span class="sd">        (faible/modéré/élevé/viral) avec des dynamiques d&#39;adoption distinctes.</span>

<span class="sd">        **3. Facteurs d&#39;optimisation :** Les caractéristiques techniques révèlent des zones</span>
<span class="sd">        d&#39;équilibre optimal entre accessibilité et valeur perçue :</span>
<span class="sd">        - Temps de préparation : équilibre entre simplicité et satisfaction</span>
<span class="sd">        - Complexité procédurale : niveau de défi optimal pour l&#39;engagement</span>
<span class="sd">        - Richesse compositionnelle : balance entre richesse et accessibilité</span>

<span class="sd">        **4. Pattern universel de viralité :** Les recettes les plus populaires suivent</span>
<span class="sd">        un cycle commun : émergence progressive, explosion virale, stabilisation ou déclin.</span>
<span class="sd">        Ce pattern reflète les mécanismes naturels des tendances culturelles.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span>
            <span class="s2">&quot;💡 **Configuration** : Ajustez les paramètres de preprocessing et visualisation pour explorer différentes perspectives analytiques.&quot;</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2025, William.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>